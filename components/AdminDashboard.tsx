"use client";
import { useState, useEffect } from "react";
import { motion } from "framer-motion";
import { supabase } from "../lib/supabase";

export default function AdminDashboard({ onBack }: { onBack: () => void }) {
    const [users, setUsers] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [stats, setStats] = useState({ totalUsers: 0, totalCredits: 0 });

    useEffect(() => {
        fetchData();
    }, []);

    const fetchData = async () => {
        setLoading(true);
        try {
            const { data, error } = await supabase
                .from('magic_users')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;

            if (data) {
                setUsers(data);
                const credits = data.reduce((acc, curr) => acc + (curr.credits || 0), 0);
                setStats({
                    totalUsers: data.length,
                    totalCredits: credits
                });
            }
        } catch (err) {
            console.error("Failed to fetch admin data", err);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="card" style={{ maxWidth: "1000px", margin: "0 auto" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "2rem" }}>
                <button onClick={onBack} className="button" style={{ background: "none", boxShadow: "none", color: "#666", padding: 0 }}>
                    â† ì—°êµ¬ì†Œë¡œ ëŒì•„ê°€ê¸°
                </button>
                <h2 style={{ color: "var(--primary)", margin: 0 }}>ì¤‘ì•™ ì‚¬ë ¹ë¶€ ëŒ€ì‹œë³´ë“œ ğŸš€</h2>
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "1.5rem", marginBottom: "2rem" }}>
                <div style={{ background: "rgba(108, 92, 231, 0.1)", padding: "1.5rem", borderRadius: "24px", textAlign: "center", border: "2px solid var(--secondary)" }}>
                    <div style={{ fontSize: "0.9rem", color: "#666" }}>ì´ ê°€ì… íˆì–´ë¡œ</div>
                    <div style={{ fontSize: "2.5rem", fontWeight: "bold", color: "var(--secondary)" }}>{stats.totalUsers} ëª…</div>
                </div>
                <div style={{ background: "rgba(255, 140, 66, 0.1)", padding: "1.5rem", borderRadius: "24px", textAlign: "center", border: "2px solid #FF8C42" }}>
                    <div style={{ fontSize: "0.9rem", color: "#666" }}>ë‚¨ì€ ì´ ë§ˆë²• ì—ë„ˆì§€</div>
                    <div style={{ fontSize: "2.5rem", fontWeight: "bold", color: "#FF8C42" }}>{stats.totalCredits} âœ¨</div>
                </div>
            </div>

            <div style={{ background: "white", borderRadius: "24px", border: "2px solid #f1f2f6", overflow: "hidden" }}>
                <div style={{ padding: "1.5rem", borderBottom: "2px solid #f1f2f6", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                    <h3 style={{ margin: 0 }}>íˆì–´ë¡œ ëª…ë‹¨ ğŸ“‹</h3>
                    <button onClick={fetchData} className="button" style={{ fontSize: "0.8rem", padding: "0.5rem 1rem" }}>ìƒˆë¡œê³ ì¹¨ ğŸ”„</button>
                </div>

                <div style={{ overflowX: "auto" }}>
                    <table style={{ width: "100%", borderCollapse: "collapse", textAlign: "left" }}>
                        <thead>
                            <tr style={{ background: "#f9f9ff" }}>
                                <th style={{ padding: "1rem" }}>ì´ë¦„</th>
                                <th style={{ padding: "1rem" }}>ì´ë©”ì¼</th>
                                <th style={{ padding: "1rem" }}>ë‚˜ì´/ì„±ë³„</th>
                                <th style={{ padding: "1rem" }}>ë“±ê¸‰</th>
                                <th style={{ padding: "1rem" }}>ì—ë„ˆì§€</th>
                                <th style={{ padding: "1rem" }}>ê°€ì…ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {loading ? (
                                <tr><td colSpan={6} style={{ padding: "3rem", textAlign: "center" }}>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... ğŸª„</td></tr>
                            ) : users.length === 0 ? (
                                <tr><td colSpan={6} style={{ padding: "3rem", textAlign: "center" }}>ì•„ì§ ê°€ì…í•œ íˆì–´ë¡œê°€ ì—†ì–´ìš”. ğŸœï¸</td></tr>
                            ) : users.map((u) => (
                                <tr key={u.id} style={{ borderBottom: "1px solid #f1f2f6" }}>
                                    <td style={{ padding: "1rem", fontWeight: "bold" }}>{u.name}</td>
                                    <td style={{ padding: "1rem", color: "#666", fontSize: "0.9rem" }}>{u.email || "-"}</td>
                                    <td style={{ padding: "1rem" }}>{u.age}ì„¸ / {u.gender === "boy" ? "ë‚¨" : "ì—¬"}</td>
                                    <td style={{ padding: "1rem" }}>
                                        <span style={{
                                            padding: "4px 10px", borderRadius: "99px", fontSize: "0.8rem",
                                            background: u.tier === "Pro" ? "var(--secondary)" : "#eee",
                                            color: u.tier === "Pro" ? "white" : "#666"
                                        }}>
                                            {u.tier}
                                        </span>
                                    </td>
                                    <td style={{ padding: "1rem", fontWeight: "bold" }}>{u.credits} âœ¨</td>
                                    <td style={{ padding: "1rem", color: "#999", fontSize: "0.8rem" }}>
                                        {new Date(u.created_at).toLocaleDateString()}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}
